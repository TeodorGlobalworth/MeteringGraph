{% extends "base.html" %}

{% block title %}Settings - MeterGraph{% endblock %}

{% block navbar %}
<div class="navbar-nav ms-auto">
    <a href="/" class="btn btn-sm btn-outline-light">
        <i class="bi bi-arrow-left"></i> Back to Projects
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container py-4">
    <h2 class="mb-4"><i class="bi bi-gear"></i> Application Settings</h2>
    
    <!-- Nav tabs -->
    <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button">
                <i class="bi bi-tags"></i> Consumer Categories
            </button>
        </li>
    </ul>
    
    <!-- Tab content -->
    <div class="tab-content" id="settingsTabContent">
        <!-- Consumer Categories Tab -->
        <div class="tab-pane fade show active" id="categories" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Consumer Category Settings</h5>
                    <button class="btn btn-primary btn-sm" onclick="openAddCategoryModal()">
                        <i class="bi bi-plus-circle"></i> Add Category
                    </button>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Configure icons and colors for consumer categories. These settings apply globally across all projects.
                    </p>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" id="categoriesTable">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">Preview</th>
                                    <th>Category Name</th>
                                    <th>Display Name</th>
                                    <th>Icon</th>
                                    <th>Color</th>
                                    <th style="width: 80px;">Order</th>
                                    <th style="width: 80px;">Active</th>
                                    <th style="width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="categoriesTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalTitle">Add Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="categoryId">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="categoryName" class="form-label">Category Name (ID) *</label>
                            <input type="text" class="form-control" id="categoryName" required 
                                   placeholder="e.g., Lighting, HVAC" pattern="[A-Za-z0-9_-]+"
                                   title="Only letters, numbers, underscore and dash">
                            <small class="text-muted">Used internally, no spaces allowed</small>
                        </div>
                        <div class="col-md-6">
                            <label for="categoryDisplayName" class="form-label">Display Name *</label>
                            <input type="text" class="form-control" id="categoryDisplayName" required
                                   placeholder="e.g., Lighting, HVAC System">
                            <small class="text-muted">Shown in UI</small>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="categoryColor" class="form-label">Background Color</label>
                            <div class="input-group">
                                <input type="color" class="form-control form-control-color" id="categoryColorPicker" 
                                       value="#868e96" onchange="document.getElementById('categoryColor').value = this.value">
                                <input type="text" class="form-control" id="categoryColor" value="#868e96"
                                       pattern="^#[0-9A-Fa-f]{6}$" placeholder="#868e96"
                                       onchange="document.getElementById('categoryColorPicker').value = this.value">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="categorySortOrder" class="form-label">Sort Order</label>
                            <input type="number" class="form-control" id="categorySortOrder" value="50" min="0" max="999">
                            <small class="text-muted">Lower numbers appear first</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Select Icon</label>
                        <div class="icon-search mb-2">
                            <input type="text" class="form-control" id="iconSearch" placeholder="Search icons..."
                                   onkeyup="filterIcons(this.value)">
                        </div>
                        <div class="icon-grid" id="iconGrid">
                            <!-- Populated by JavaScript -->
                        </div>
                        <input type="hidden" id="categoryIcon" value="box-fill">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Preview</label>
                        <div class="preview-container d-flex align-items-center gap-3">
                            <div class="category-preview" id="categoryPreview">
                                <i class="bi bi-box-fill"></i>
                            </div>
                            <span class="text-muted">This is how the node will appear on the graph</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCategory()">Save</button>
            </div>
        </div>
    </div>
</div>

<style>
.icon-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
    gap: 8px;
    max-height: 250px;
    overflow-y: auto;
    padding: 10px;
    background: var(--bg-secondary);
    border-radius: 4px;
    border: 1px solid var(--border-color);
}

.icon-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 8px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.icon-item:hover {
    background: var(--bg-tertiary);
}

.icon-item.selected {
    border-color: var(--accent-primary);
    background: var(--bg-tertiary);
}

.icon-item i {
    font-size: 1.5rem;
}

.icon-item small {
    font-size: 0.6rem;
    text-align: center;
    margin-top: 2px;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}

.category-preview {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #868e96;
}

.category-preview i {
    font-size: 1.8rem;
    color: white;
}

.table .preview-cell {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.table .preview-cell i {
    font-size: 1.2rem;
    color: white;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let allIcons = [];
let categoryModal = null;
let isEditing = false;

document.addEventListener('DOMContentLoaded', function() {
    categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));
    loadCategories();
    loadIcons();
});

async function loadCategories() {
    try {
        const response = await fetch('/api/settings/consumer-categories');
        const categories = await response.json();
        renderCategoriesTable(categories);
    } catch (error) {
        showToast('Error loading categories: ' + error.message, 'danger');
    }
}

function renderCategoriesTable(categories) {
    const tbody = document.getElementById('categoriesTableBody');
    
    if (categories.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No categories defined</td></tr>';
        return;
    }
    
    tbody.innerHTML = categories.map(cat => `
        <tr>
            <td>
                <div class="preview-cell" style="background: ${cat.color};">
                    <i class="bi bi-${cat.icon_name}"></i>
                </div>
            </td>
            <td><code>${cat.category_name}</code></td>
            <td>${cat.display_name}</td>
            <td><i class="bi bi-${cat.icon_name}"></i> ${cat.icon_name}</td>
            <td>
                <span class="badge" style="background: ${cat.color};">${cat.color}</span>
            </td>
            <td>${cat.sort_order}</td>
            <td>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" 
                           ${cat.is_active ? 'checked' : ''} 
                           onchange="toggleCategoryActive(${cat.id}, this.checked)">
                </div>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editCategory(${cat.id})" title="Edit">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${cat.id}, '${cat.category_name}')" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

async function loadIcons() {
    try {
        const response = await fetch('/api/settings/bootstrap-icons');
        allIcons = await response.json();
        renderIconGrid(allIcons);
    } catch (error) {
        showToast('Error loading icons: ' + error.message, 'danger');
    }
}

function renderIconGrid(icons) {
    const grid = document.getElementById('iconGrid');
    const selectedIcon = document.getElementById('categoryIcon').value;
    
    grid.innerHTML = icons.map(icon => `
        <div class="icon-item ${icon.name === selectedIcon ? 'selected' : ''}" 
             onclick="selectIcon('${icon.name}')" 
             data-icon="${icon.name}" 
             data-label="${icon.label.toLowerCase()}">
            <i class="bi bi-${icon.name}"></i>
            <small>${icon.label}</small>
        </div>
    `).join('');
}

function filterIcons(query) {
    const items = document.querySelectorAll('.icon-item');
    const q = query.toLowerCase();
    
    items.forEach(item => {
        const label = item.dataset.label;
        const name = item.dataset.icon;
        if (label.includes(q) || name.includes(q)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

function selectIcon(iconName) {
    document.getElementById('categoryIcon').value = iconName;
    
    // Update selection UI
    document.querySelectorAll('.icon-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.icon === iconName);
    });
    
    updatePreview();
}

function updatePreview() {
    const icon = document.getElementById('categoryIcon').value;
    const color = document.getElementById('categoryColor').value;
    const preview = document.getElementById('categoryPreview');
    
    preview.style.background = color;
    preview.innerHTML = `<i class="bi bi-${icon}"></i>`;
}

// Attach change listeners for preview
document.getElementById('categoryColor').addEventListener('change', updatePreview);
document.getElementById('categoryColorPicker').addEventListener('input', function() {
    document.getElementById('categoryColor').value = this.value;
    updatePreview();
});

function openAddCategoryModal() {
    isEditing = false;
    document.getElementById('categoryModalTitle').textContent = 'Add Category';
    document.getElementById('categoryForm').reset();
    document.getElementById('categoryId').value = '';
    document.getElementById('categoryIcon').value = 'box-fill';
    document.getElementById('categoryColor').value = '#868e96';
    document.getElementById('categoryColorPicker').value = '#868e96';
    document.getElementById('categoryName').removeAttribute('readonly');
    
    renderIconGrid(allIcons);
    updatePreview();
    categoryModal.show();
}

async function editCategory(id) {
    try {
        const response = await fetch('/api/settings/consumer-categories');
        const categories = await response.json();
        const cat = categories.find(c => c.id === id);
        
        if (!cat) {
            showToast('Category not found', 'danger');
            return;
        }
        
        isEditing = true;
        document.getElementById('categoryModalTitle').textContent = 'Edit Category';
        document.getElementById('categoryId').value = cat.id;
        document.getElementById('categoryName').value = cat.category_name;
        document.getElementById('categoryName').setAttribute('readonly', 'readonly');
        document.getElementById('categoryDisplayName').value = cat.display_name;
        document.getElementById('categoryIcon').value = cat.icon_name;
        document.getElementById('categoryColor').value = cat.color;
        document.getElementById('categoryColorPicker').value = cat.color;
        document.getElementById('categorySortOrder').value = cat.sort_order;
        
        renderIconGrid(allIcons);
        updatePreview();
        categoryModal.show();
    } catch (error) {
        showToast('Error loading category: ' + error.message, 'danger');
    }
}

async function saveCategory() {
    const form = document.getElementById('categoryForm');
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }
    
    const id = document.getElementById('categoryId').value;
    const data = {
        category_name: document.getElementById('categoryName').value,
        display_name: document.getElementById('categoryDisplayName').value,
        icon_name: document.getElementById('categoryIcon').value,
        color: document.getElementById('categoryColor').value,
        sort_order: parseInt(document.getElementById('categorySortOrder').value) || 50
    };
    
    try {
        let response;
        if (isEditing && id) {
            response = await fetch(`/api/settings/consumer-categories/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        } else {
            response = await fetch('/api/settings/consumer-categories', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        }
        
        if (response.ok) {
            showToast('Category saved successfully', 'success');
            categoryModal.hide();
            loadCategories();
        } else {
            const error = await response.json();
            showToast('Error: ' + error.error, 'danger');
        }
    } catch (error) {
        showToast('Error saving category: ' + error.message, 'danger');
    }
}

async function toggleCategoryActive(id, isActive) {
    try {
        const response = await fetch(`/api/settings/consumer-categories/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ is_active: isActive })
        });
        
        if (!response.ok) {
            throw new Error('Failed to update');
        }
    } catch (error) {
        showToast('Error updating category: ' + error.message, 'danger');
        loadCategories(); // Reload to reset checkbox
    }
}

async function deleteCategory(id, name) {
    if (!confirm(`Are you sure you want to delete category "${name}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/settings/consumer-categories/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Category deleted', 'success');
            loadCategories();
        } else {
            const error = await response.json();
            showToast('Error: ' + error.error, 'danger');
        }
    } catch (error) {
        showToast('Error deleting category: ' + error.message, 'danger');
    }
}
</script>
{% endblock %}
