{% extends "base.html" %}

{% block title %}MeterGraph - Building Metering{% endblock %}

{% block navbar %}
<div class="navbar-nav ms-auto">
    <a href="/settings" class="btn btn-sm btn-outline-light">
        <i class="bi bi-gear"></i> Settings
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-4">Buildings</h1>
            <p class="lead">Manage your building metering topology</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#newProjectModal">
                <i class="bi bi-plus-circle"></i> New Building
            </button>
        </div>
    </div>

    <!-- Projects Grid -->
    <div id="projectsGrid" class="row g-4">
        <!-- Projects will be loaded here -->
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading buildings...</p>
    </div>
</div>

<!-- New Project Modal -->
<div class="modal fade" id="newProjectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New building</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newProjectForm">
                    <div class="mb-3">
                        <label for="projectName" class="form-label">Buidling Name *</label>
                        <input type="text" class="form-control" id="projectName" required>
                    </div>
                    <p class="text-muted small">
                        <i class="bi bi-info-circle"></i> 
                        Each project includes all three utility infrastructures: 
                        <span class="text-warning"><i class="bi bi-lightning-charge"></i> Electricity</span>, 
                        <span class="text-primary"><i class="bi bi-droplet"></i> Water</span>, and 
                        <span class="text-danger"><i class="bi bi-thermometer-half"></i> Heating</span>.
                    </p>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createProjectBtn">Create building</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load projects on page load
document.addEventListener('DOMContentLoaded', function() {
    loadProjects();
    
    // Create project button handler
    document.getElementById('createProjectBtn').addEventListener('click', createProject);
});

async function loadProjects() {
    try {
        const response = await fetch('/api/projects');
        const projects = await response.json();
        
        const grid = document.getElementById('projectsGrid');
        const spinner = document.getElementById('loadingSpinner');
        
        spinner.style.display = 'none';
        
        if (projects.length === 0) {
            grid.innerHTML = `
                <div class="col-12 text-center text-muted my-5">
                    <i class="bi bi-folder-x" style="font-size: 4rem;"></i>
                    <p class="mt-3">No buildings yet. Create your first building to get started.</p>
                </div>
            `;
            return;
        }
        
        grid.innerHTML = projects.map(project => `
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 project-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-building"></i> ${project.name}
                        </h5>
                        <p class="card-text text-muted small">
                            Created: ${new Date(project.created_at).toLocaleDateString()}
                        </p>
                        <div class="mb-3">
                            <span class="badge bg-secondary">
                                <i class="bi bi-diagram-3"></i> ${project.node_count || 0} nodes
                            </span>
                            <span class="badge bg-warning"><i class="bi bi-lightning-charge"></i></span>
                            <span class="badge bg-primary"><i class="bi bi-droplet"></i></span>
                            <span class="badge bg-danger"><i class="bi bi-thermometer-half"></i></span>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-flex gap-2">
                            <a href="/api/projects/${project.id}/view" class="btn btn-primary btn-sm flex-grow-1">
                                <i class="bi bi-box-arrow-up-right"></i> Open
                            </a>
                            <button class="btn btn-outline-secondary btn-sm" onclick="exportProject(${project.id}, '${project.name}')">
                                <i class="bi bi-download"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteProject(${project.id}, '${project.name}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        showToast('Error loading projects: ' + error.message, 'danger');
    }
}

async function createProject() {
    const name = document.getElementById('projectName').value;
    
    if (!name) {
        showToast('Please enter a project name', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/projects', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name})
        });
        
        if (response.ok) {
            const project = await response.json();
            showToast('Project created successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('newProjectModal')).hide();
            document.getElementById('newProjectForm').reset();
            window.location.href = `/api/projects/${project.id}/view`;
        } else {
            const error = await response.json();
            showToast('Error creating project: ' + error.error, 'danger');
        }
    } catch (error) {
        showToast('Error creating project: ' + error.message, 'danger');
    }
}

async function exportProject(projectId, projectName) {
    try {
        const response = await fetch(`/api/projects/${projectId}/export`);
        const data = await response.json();
        
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${projectName}_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        
        showToast('Project exported successfully', 'success');
    } catch (error) {
        showToast('Error exporting project: ' + error.message, 'danger');
    }
}

async function deleteProject(projectId, projectName) {
    if (!confirm(`Are you sure you want to delete "${projectName}"? This action cannot be undone and will delete all nodes, relationships, and readings.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/projects/${projectId}`, {method: 'DELETE'});
        
        if (response.ok) {
            showToast('Project deleted successfully', 'success');
            loadProjects();
        } else {
            const error = await response.json();
            showToast('Error deleting project: ' + error.error, 'danger');
        }
    } catch (error) {
        showToast('Error deleting project: ' + error.message, 'danger');
    }
}

function getUtilityIcon(type) {
    const icons = {
        water: '<i class="bi bi-droplet text-primary"></i>',
        electricity: '<i class="bi bi-lightning-charge text-warning"></i>',
        heating: '<i class="bi bi-thermometer-half text-danger"></i>'
    };
    return icons[type] || '<i class="bi bi-question-circle"></i>';
}

function getUtilityColor(type) {
    const colors = {
        water: 'primary',
        electricity: 'warning',
        heating: 'danger'
    };
    return colors[type] || 'secondary';
}
</script>
{% endblock %}
